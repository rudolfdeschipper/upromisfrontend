/*
**             ------ IMPORTANT ------
** This file was generated by ZeroCode2 on 30/Jan/2021 16:24:39
** DO NOT MODIFY IT, as it can be regenerated at any moment.
** If you need this file changed, change the underlying model or its template.
*/

import { ILoadResult, IListInfo, ISaveMessage, IAPIResult, ISelectValueList } from '../../GeneralTypes';
import { http, HttpResponse } from '../../http';
import { Utils } from '../../Utils';

import { IProposalData } from './ProposalTypes';

export class ProposalAPI {

    static debug : boolean = true;

    static webAPIUrl : string = 'http://localhost:5001/api';

    static loadList = async (listInfo: IListInfo, token: string) : Promise<ILoadResult<IProposalData>> => 
    {
        try {
            const result = await http<IListInfo, ILoadResult<IProposalData>>( ProposalAPI.webAPIUrl,
                {
                    path: '/proposal/getlist',
                    method: 'post',
                    body: listInfo,
                    accessToken: token
                }
            );
            if (result.ok && result.parsedBody) {
                return {...result.parsedBody };
            } else {
                return { data: [], pages: 0, message: result.statusText  };
            }
        } catch (ex) {
            if(ProposalAPI.debug) console.error(ex);
            return { data: [], pages: 0, message: ex  };
        }

    }


    static loadListForExport = async (title: string, listInfo: IListInfo, token: string)  : Promise<void> => 
    {
        try {
            const result = await http<IListInfo, any>( ProposalAPI.webAPIUrl,
                {
                    path: '/proposal/getforexport',
                    method: 'post',
                    body: { ...listInfo, page: 1},
                    accessToken: token
                }
            )
            result.blob().then(blob => {
                    let url = window.URL.createObjectURL(blob);
                    let a = document.createElement('a');
                    let filename = title + " - " + Utils.formatDate(Date.now()).replace(/\//g, "-") + ".xlsx";
                    a.href = url;
                    a.download = filename;
                    a.click();
                    a.remove();
                });
        } catch (ex) {
            if(ProposalAPI.debug) console.error(ex);
        }
    }


    static saveRecord = async (message: ISaveMessage<IProposalData>, token: string): Promise<IAPIResult<IProposalData>> => {

        return await http<ISaveMessage<IProposalData>, IAPIResult<IProposalData>>(
            ProposalAPI.webAPIUrl,
            {
                path: '/proposal',
                method: message.action,
                body: message,
                accessToken: token
            }
        )
        .then((result) => {
            if (result.ok && result.parsedBody) {
                if(ProposalAPI.debug) console.log("API result ok & parsebody set");
                return { ...result.parsedBody, success: true };
            } else {
                if(ProposalAPI.debug) console.log("API result not ok | parsebody not set");
                return { 
                    id: message.id, 
                    dataSubject: undefined, 
                    success: false, 
                    message: result.statusText
                };
            }
        }, (rejectedResult: HttpResponse<IAPIResult<IProposalData>>) => {
            if(ProposalAPI.debug) console.log("API rejected result not ok");
            return { 
                id: message.id, 
                dataSubject: undefined, 
                success: false, 
                message: rejectedResult.statusText, 
                additionalInfo: rejectedResult.parsedBody?.additionalInfo
            };
        }
        )
        .catch(ex => {
            if(ProposalAPI.debug) console.error("API saveRecord exception:");
            if(ProposalAPI.debug) console.log(ex);
            return { 
                id: message.id, 
                dataSubject: undefined, 
                success: false, 
                message: ex.statusText, 
                additionalInfo: (ex as HttpResponse<IAPIResult<IProposalData>>).parsedBody?.additionalInfo
            };
        });
    };

    static loadOneRecord = async (id: number, token: string): Promise<IAPIResult<IProposalData>> => {

        try {
            const result = await http<ISaveMessage<IProposalData>, IAPIResult<IProposalData>>(
                ProposalAPI.webAPIUrl,
                {
                    path: '/proposal/' + id,
                    method: 'get',
                    accessToken: token
                }
            );
            if (result.ok && result.parsedBody) {
                return {...result.parsedBody, success: true };
            } else {
                return { id: id, dataSubject: undefined, success: false,  message: result.statusText };
            }
        } catch (ex) {
            if(ProposalAPI.debug) console.error(ex);
            return { id: id, dataSubject: undefined, success: false,  message: ex };
        }

    }

    static loadDropdownValues = async (valueType: string, token: string): Promise<ISelectValueList> => {

        try {
            const result = await http<any, ISelectValueList>(
                ProposalAPI.webAPIUrl,
                {
                    path: '/proposal/getselectvalues',
                    method: 'post',
                    body: {valueType: valueType},
                    accessToken: token
                }
            );
            if (result.ok && result.parsedBody) {
                return {...result.parsedBody };
            } else {
                return { data: [], valueType: valueType };
            }
        } catch (ex) {
            if(ProposalAPI.debug) console.error(ex);
            return { data: [], valueType: valueType };
        }
    }

}

